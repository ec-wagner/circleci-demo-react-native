workflows:
    version: 2
    build-test-deploy:
        jobs:
            # ALLGEMEINER BUILD JOB
            - build:
                filters:
                    branches:
                        only: dev

            # ANDROID UNIT TESTS
            - test_dev_android:
                filters:
                    branches:
                        only: dev
                requires:
                    - build

            # IOS UNIT TESTS
            # - test_dev_ios          --| build
            # - test_dev_web          --| build

            # MERGE DEV BRANCH INTO STAGE
            - merge_into_stage:
                filters:
                    branches:
                        only: stage
                requires:
                    - test_dev_android
                    # - test_dev_ios
                    # - test_dev_web

            - test_stage_android
            # - test_stage_ios
            # - test_stage_web
            #
            # - merge_into_master
            # - deploy_pre-prod



version: 2
jobs:
    # ALLGEMEINER BUILD JOB
    build:
        working_directory: ~/demo-react-native
        docker:
            - image: circleci/node:8
        steps:
            - checkout

            #- restore_cache:
            #    key: yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}

            #- restore_cache:
            #    key: node-v1-{{ checksum "package.json" }}-{{ arch }}

            - run: yarn install

            #- save_cache:
            #    key: yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
            #    paths:
            #      - ~/.cache/yarn

            #- save_cache:
            #    key: node-v1-{{ checksum "package.json" }}-{{ arch }}
            #    paths:
            #      - node_modules

            # - run:
            #     name: jest tests
            #     command: |
            #         mkdir -p test-results/jest
            #         yarn run test
            #     environment:
            #         JEST_JUNIT_OUTPUT: test-results/jest/junit.xml
            #
            # - persist_to_workspace:
            #     root: ~/demo-react-native
            #     paths:
            #         - node_modules
            #
            # - store_test_results:
            #     path: test-results
            #
            # - store_artifacts:
            #     path: test-results

            - run: echo "BUILD SUCCEEDED!"


    # ANDROID UNIT TESTS
    test_dev_android:
        working_directory: ~/demo-react-native/android
        docker:
            - image: circleci/android:api-27-node8-alpha
        steps:
            - checkout:
                path: ~/demo-react-native

            # - attach_workspace:
            #     at: ~/demo-react-native
            #
            # #- restore_cache:
            # #    key: bundle-v1-{{ checksum "Gemfile.lock" }}-{{ arch }}
            #
            # - run: bundle install
            # - run: bundle update fastlane
            #
            # #- save_cache:
            # #    key: bundle-v1-{{ checksum "Gemfile.lock" }}-{{ arch }}
            # #    paths:
            # #      - vendor/bundle
            #
            # - run:
            #     name: fastlane tests
            #     command: |
            #         mkdir -p test-results/fastlane
            #         bundle exec fastlane test
            #         mv fastlane/report.xml test-results/fastlane
            #
            # - store_test_results:
            #     path: test-results
            #
            # - store_artifacts:
            #     path: test-results

            - run: echo "DEV TEST PASS"


    # MERGE DEV BRANCH INTO STAGE
    merge_into_stage:
        working_directory: ~/demo-react-native
        docker:
            - image: circleci/node:8
        steps:
            - checkout
            - run:
                name: merge dev into stage
                command: |
                    git merge --no-commit dev
                    git commit -m "merge dev into stage"
